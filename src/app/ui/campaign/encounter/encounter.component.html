<div class="content">
  @if (encounter) {
    <div class="intro">
      @if (encounter.isFinished()) {
        <badge label="finished" [disabled]="true"></badge>
      } @else if (encounter.isStarted()) {
        <badge label="finish" (clicked)="onFinishEncounter()"></badge>
      } @else {
        <badge label="start" (clicked)="onStartEncounter()"></badge>
      }

      <div class="details">
        <div class="line">
          <div class="label">Location:</div>
          {{ encounter.locations().join("; ") }}
          @if (encounter.map()) {
            (map {{ encounter.map() }})
          }
        </div>

        <div class="line">
          <div class="label">Sounds:</div>
          @for (sound of encounter.soundSources(); track sound) {
            @if (!$first) {
              |
            }
            <dma-link [text]="sound" target="dma-sounds"></dma-link>
          }
        </div>

        @if (encounter.notes.length) {
          <div class="line">
            <div class="label">Notes:</div>
            <ul>
              @for (note of encounter.notes(); track note) {
                <li>{{ note }}</li>
              }
            </ul>
          </div>
        }
      </div>

      <div class="images">
        @for (image of encounter.imageSources(); track image) {
          <div class="image-container">
            <img class="image" [src]="image.url" />
            <div class="caption">{{ image.label }}</div>
            <div class="image-hover">
              <img class="image" [src]="image.url" />
              <screen-image-button [campaign]="encounter.adventure.campaign" [image]="image.url"></screen-image-button>
            </div>
          </div>
        }
      </div>
    </div>

    <div class="entities-collapsed">
      @for (npc of encounter.npcs(); track npc) {
        @if (!expandedNPCs.has(npc.npc.name)) {
          <npc
            class="npc"
            [npc]="npc.npc"
            [campaign]="encounter.adventure.campaign"
            [collapsed]="true"
            (expand)="expandedNPCs.add(npc.npc.name)"
          ></npc>
        }
      }
    </div>

    <div class="npcs">
      @for (npc of encounter.npcs(); track npc) {
        @if (expandedNPCs.has(npc.npc.name)) {
          <npc
            [npc]="npc.npc"
            [campaign]="encounter.adventure.campaign"
            [collapsed]="false"
            [miniature]="npc.campaignNPC.miniature()"
            (collapse)="expandedNPCs.delete(npc.npc.name)"
          ></npc>
        }
      }
    </div>

    <div class="entities-collapsed">
      @for (monster of encounter.monsters(); track monster) {
        @if (!expandedMonsters.has(monster.value.name)) {
          <monster
            class="monster"
            [monster]="monster.value"
            [campaign]="encounter.adventure.campaign"
            [collapsed]="true"
            [count]="monster.count"
            (expand)="expandedMonsters.add(monster.value.name)"
          ></monster>
        }
      }
    </div>

    <div class="monsters">
      @for (monster of encounter.monsters(); track monster) {
        @if (expandedMonsters.has(monster.value.name)) {
          <monster
            [monster]="monster.value"
            [campaign]="encounter.adventure.campaign"
            [collapsed]="false"
            [count]="monster.count"
            [miniatures]="encounter.miniatures().get(monster.value.name) || []"
            (collapse)="expandedMonsters.delete(monster.value.name)"
          ></monster>
        }
      }
    </div>

    <div class="entities-collapsed">
      @for (item of encounter.items(); track item) {
        @if (!expandedItems.has(item.value.name)) {
          <item
            class="item"
            [count]="item.count"
            [item]="item.value"
            [campaign]="encounter.adventure.campaign"
            [collapsed]="true"
            (expand)="expandedItems.add(item.value.name)"
          ></item>
        }
      }
    </div>

    <div class="entities-expanded">
      @for (item of encounter.items(); track item.value.name) {
        @if (expandedItems.has(item.value.name)) {
          <item
            [item]="item.value"
            [campaign]="encounter.adventure.campaign"
            [collapsed]="false"
            [count]="item.count"
            (collapse)="expandedItems.delete(item.value.name)"
          ></item>
        }
      }
    </div>

    <div class="entities-collapsed">
      @for (spell of encounter.spells(); track spell.name) {
        @if (!expandedSpells.has(spell.name)) {
          <spell [spell]="spell" [collapsed]="true" (expand)="expandedSpells.add(spell.name)"></spell>
        }
      }
    </div>

    <div class="entities-expanded">
      @for (spell of encounter.spells(); track spell.name) {
        @if (expandedSpells.has(spell.name)) {
          <spell [spell]="spell" [collapsed]="false" (expand)="expandedSpells.delete(spell.name)"></spell>
        }
      }
    </div>
  }
</div>

<div class="actions">
  <button mat-fab color="primary" (click)="onAdd()" matTooltip="Add Encounter">
    <mat-icon>add</mat-icon>
  </button>
  <button mat-fab color="primary" (click)="onEdit()" [disabled]="!encounter" matTooltip="Edit Encounter">
    <mat-icon>edit</mat-icon>
  </button>
  <button mat-fab color="primary" (click)="onDuplicate()" [disabled]="!encounter" matTooltip="Duplicate Encounter">
    <mat-icon>content_copy</mat-icon>
  </button>
  <button mat-fab color="primary" (click)="onMini()" [disabled]="!encounter" matTooltip="Select Miniatures">
    <img src="/assets/monsters.webp" />
  </button>
  <button mat-fab color="primary" (click)="onDelete()" [disabled]="!encounter" matTooltip="Delete Encounter">
    <mat-icon>delete</mat-icon>
  </button>
</div>
